<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ciência Interativa Neuro-Acessível</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script>
        // Suas chaves do Firebase aqui.
        const firebaseConfig = {
          apiKey: "AIzaSyAwF2uHeWkdddnpYdwratOkfutE9JU46R8",
          authDomain: "ciencia-interativa-online.firebaseapp.com",
          projectId: "ciencia-interativa-online",
          storageBucket: "ciencia-interativa-online.firebasestorage.app",
          messagingSenderId: "1080074325421",
          appId: "1:1080074325421:web:94e8d060c13a136c896524",
          measurementId: "G-73EP5CLWVG"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>

    <style>
        :root {
            --font-primary: 'Poppins', sans-serif;
            --cor-fundo: #F8F9FA;
            --cor-card: rgba(255, 255, 255, 0.6);
            --cor-texto-primario: #212529;
            --cor-texto-secundario: #6C757D;
            --cor-borda-vidro: rgba(200, 200, 220, 0.4);
            --cor-sombra: rgba(0, 0, 0, 0.1);
            --cor-fisica: #007BFF;
            --cor-quimica: #7E57C2;
            --cor-biologia: #28A745;
            --cor-matematica: #FFC107;
            --cor-geral: #007BFF;
            --cor-correto: #28A745;
            --cor-errado: #DC3545;
            --cor-neutro: #FFC107;
            --glass-blur: 15px;
            --transition-speed: 0.4s;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary);
            background-color: var(--cor-fundo);
            color: var(--cor-texto-primario);
            overflow-x: hidden;
            text-align: center;
            transition: background-color var(--transition-speed) ease;
        }

        #dynamic-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        .screen {
            position: absolute; top: 0; left: 0;
            width: 100%; min-height: 100vh; height: auto;
            padding: 2rem; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding-top: 6rem;
            opacity: 0; visibility: hidden;
            transform: translateY(20px);
            transition: opacity var(--transition-speed) ease-out, transform var(--transition-speed) ease-out, visibility 0s var(--transition-speed);
            overflow-y: auto;
        }
        .screen#mainMenu, .screen#gameLobbyScreen { justify-content: center; padding-top: 2rem; }
        .screen.active {
            opacity: 1; transform: translateY(0); visibility: visible;
            transition: opacity var(--transition-speed) ease-out, transform var(--transition-speed) ease-out;
        }

        .glass-card {
            background: var(--cor-card); border: 1px solid var(--cor-borda-vidro);
            border-radius: 20px; backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: 0 8px 32px 0 var(--cor-sombra);
            padding: clamp(1.5rem, 4vw, 2.5rem);
            transition: all var(--transition-speed) ease;
            width: 100%;
        }
        
        .page-header {
            position: absolute; top: 2rem; left: 2rem;
            width: auto;
        }
        .page-title {
            font-size: clamp(2.5rem, 6vw, 4rem); font-weight: 800; margin-bottom: 0.5rem;
            background: linear-gradient(45deg, var(--cor-fisica), var(--cor-quimica));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .page-subtitle {
            font-size: clamp(1rem, 2vw, 1.2rem); color: var(--cor-texto-secundario);
            font-weight: 400; margin-bottom: 2.5rem; max-width: 800px;
        }
        .btn {
            padding: 0.8rem 1.8rem; font-size: 1rem; font-weight: 600;
            border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            border: 2px solid transparent; display: inline-flex; align-items: center;
            gap: 0.5rem; justify-content: center; text-decoration: none;
        }
        .btn-primary { background-color: var(--cor-geral); color: white; }
        .btn:hover, .btn.focused { transform: translateY(-5px) scale(1.05); box-shadow: 0 10px 20px rgba(0, 123, 255, 0.2); }
        .btn-secondary { background-color: transparent; color: var(--cor-texto-secundario); border: 2px solid var(--cor-borda-vidro); }
        .btn-secondary:hover, .btn-secondary.focused { border-color: var(--cor-geral); color: var(--cor-geral); box-shadow: none; background-color: rgba(0, 123, 255, 0.1); }
        .btn-danger { background-color: var(--cor-errado); color: white; border-color: transparent; }
        .btn-danger:hover { background-color: #a71d2a; box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3); }
        .btn-success { background-color: var(--cor-correto); color: white; }
        .btn-success:hover { box-shadow: 0 10px 20px rgba(40, 167, 69, 0.2); }

        .input-field, .select-field {
            width: 100%; padding: 1rem; font-size: 1rem;
            background-color: rgba(248, 249, 250, 0.9);
            border: 1px solid var(--cor-borda-vidro); border-radius: 12px;
            color: var(--cor-texto-primario); margin-bottom: 1rem;
            font-family: var(--font-primary);
        }
        .form-group { width: 100%; text-align: left; margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }

        #mainMenu .content-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem; max-width: 1200px;
        }
        .subject-card { cursor: pointer; text-align: center; color: var(--cor-texto-primario); transform-style: preserve-3d; }
        .subject-card:hover { transform: translateY(-15px) rotateX(5deg) rotateY(-5deg); box-shadow: 0 20px 40px var(--cor-sombra); }
        .subject-card .icon { font-size: 4rem; margin-bottom: 1rem; transition: color 0.3s ease; }
        .subject-card h2 { font-size: 2rem; font-weight: 700; }
        .subject-card.fisica .icon { color: var(--cor-fisica); }
        .subject-card.quimica .icon { color: var(--cor-quimica); }
        .subject-card.biologia .icon { color: var(--cor-biologia); }
        .subject-card.matematica .icon { color: var(--cor-matematica); }
        
        .actions-bar { margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        .actions-bar .btn { min-width: 250px; }

        #quizScreen { max-width: 1200px; }
        .quiz-header {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding: 1rem; position: sticky; top: 1rem; z-index: 10;
        }
        .quiz-stat { font-size: 1.3rem; font-weight: 600; }
        .quiz-question-area { padding: 2rem; margin-bottom: 1.5rem; min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #questionMedia { margin-bottom: 1rem; max-width: 100%; max-height: 200px; border-radius: 10px; }
        #questionText { font-size: clamp(1.5rem, 3vw, 2.2rem); font-weight: 700; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; }
        .option-button {
            padding: 1.5rem; font-size: 1.2rem; font-weight: 600;
            border-radius: 12px; cursor: pointer; color: white;
            display: flex; align-items: center; gap: 1rem; min-height: 80px;
        }
        .option-button:disabled { opacity: 0.6; cursor: not-allowed; }
        .option-button .shape { font-size: 1.5rem; }
        .option-button.triangulo { background-color: #c0392b; }
        .option-button.losango { background-color: #2980b9; }
        .option-button.circulo { background-color: #f39c12; }
        .option-button.quadrado { background-color: #27ae60; }
        .option-button.correct { animation: pulseCorrect 0.8s; background-color: var(--cor-correto) !important; }
        .option-button.wrong { animation: shake 0.5s; background-color: var(--cor-errado) !important; opacity: 0.5; }
        .option-button.reveal-correct { animation: pulseCorrect 0.8s; border: 4px solid white; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 50%, 90% { transform: translateX(-8px); } 30%, 70% { transform: translateX(8px); } }
        @keyframes pulseCorrect { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #accessibility-toolbar {
            position: fixed; top: 50%; right: 0; transform: translateY(-50%); z-index: 2000;
            display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem;
            background: var(--cor-card); backdrop-filter: blur(var(--glass-blur));
            border-radius: 15px 0 0 15px; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .access-btn {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--cor-borda-vidro);
            color: var(--cor-texto-secundario); background: transparent; font-size: 1.5rem;
            cursor: pointer; transition: all 0.3s ease;
        }
        .access-btn:hover { color: var(--cor-texto-primario); background-color: rgba(0,0,0,0.05); transform: scale(1.1); }
        .access-btn.active { background-color: var(--cor-correto); color: white; border-color: var(--cor-correto); animation: pulseActive 1.5s infinite; }
        @keyframes pulseActive { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }

        #eye-cursor {
            position: fixed; width: 35px; height: 35px; border: 3px solid white; border-radius: 50%;
            background-color: rgba(255, 193, 7, 0.5); z-index: 10000; pointer-events: none;
            display: none; transition: transform 0.1s linear, background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
        }
        #eye-cursor.blinking { transform: scale(1.6) !important; background-color: var(--cor-neutro); }
        #eye-cursor.dragging { transform: scale(1.3) !important; background-color: var(--cor-correto); box-shadow: 0 0 25px var(--cor-correto); }
        
        #video-preview {
            display: none; position: fixed; bottom: 20px; left: 20px;
            width: 160px; height: 120px; border-radius: 15px; border: 3px solid var(--cor-geral);
            z-index: 999; box-shadow: 0 5px 20px var(--cor-sombra);
            transform: scaleX(-1); background-color: #000;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            width: 90%; max-width: 500px; text-align: center;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 1.5rem; font-size: 1.8rem; }
        .modal-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;}
        
        .list-item {
            background: rgba(255,255,255,0.5); border: 1px solid var(--cor-borda-vidro);
            padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1rem;
            display: flex; justify-content: space-between; align-items: center; text-align: left;
        }
        .list-item-title { font-weight: 600; font-size: 1.1rem; }
        .list-item-actions button {
            background: none; border: none; color: var(--cor-texto-secundario); cursor: pointer;
            font-size: 1.1rem; margin-left: 0.5rem; padding: 0.5rem; transition: color 0.3s;
        }
        .list-item-actions button:hover { color: var(--cor-texto-primario); }
        
        .question-editor {
            background: rgba(0,0,0,0.05); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px dashed var(--cor-borda-vidro);
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .question-editor.is-dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: 0 10px 30px var(--cor-sombra);
            cursor: grabbing;
            z-index: 100;
            position: relative;
        }
        .option-editor { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
        .option-editor input[type="radio"] { width: 20px; height: 20px; flex-shrink: 0; }
        
        #gameLobbyScreen .lobby-code {
            font-size: clamp(2rem, 8vw, 4rem); font-weight: 800; letter-spacing: 5px;
            background: var(--cor-geral); color: white; padding: 1rem 2rem; border-radius: 15px; margin: 1rem 0;
        }
        #playerList {
            display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;
            margin-top: 2rem; min-height: 50px;
        }
        .player-chip {
            background: white; color: var(--cor-texto-primario); font-weight: 600;
            padding: 0.5rem 1rem; border-radius: 50px; box-shadow: 0 2px 5px var(--cor-sombra);
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #leaderboardOverlay { position: fixed; top: 0; left: 0; z-index: 100; }
        #leaderboardOverlay .modal-content { max-width: 600px; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid var(--cor-borda-vidro); font-size: 1.2rem; }
        .leaderboard-item:last-child { border-bottom: none; }
        .leaderboard-item .rank { font-weight: 800; width: 30px; }
        .leaderboard-item .name { flex-grow: 1; text-align: left; margin-left: 1rem; }
        .leaderboard-item .score { font-weight: 600; }

        #marketplaceScreen .filters { margin-bottom: 2rem; display: flex; gap: 1rem; justify-content: center; }
        #marketplace-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; max-width: 1400px; }
        .marketplace-card { text-align: left; }
        .marketplace-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; }
        .marketplace-card p { font-size: 0.9rem; color: var(--cor-texto-secundario); margin-bottom: 1rem; }
        .marketplace-card .author { font-weight: 600; }
        .marketplace-card .stats { display: flex; gap: 1.5rem; margin-top: 1.5rem; border-top: 1px solid var(--cor-borda-vidro); padding-top: 1.5rem; }
        .marketplace-card .stats span { font-weight: 600; }
        
        @media (max-width: 768px) {
            .options-grid { grid-template-columns: 1fr; }
            .actions-bar { flex-direction: column; align-items: center; }
            .page-title { font-size: 2rem; }
            .page-header { top: 1rem; left: 1rem; }
        }
    </style>
</head>
<body>
    <canvas id="dynamic-background"></canvas>
    <video id="video-preview" playsinline></video>
    <div id="eye-cursor"></div>
    <aside id="accessibility-toolbar">
        <button id="access-cam-btn" class="access-btn" title="Ativar Neuro Control (Câmera)"><i class="fas fa-video"></i></button>
        <button id="access-mic-btn" class="access-btn" title="Ativar Comandos de Voz"><i class="fas fa-microphone"></i></button>
        <button id="access-settings-btn" class="access-btn" title="Ajustar Sensibilidade"><i class="fas fa-cog"></i></button>
    </aside>

    <main id="mainMenu" class="screen active">
        <h1 class="page-title">Ciência Interativa</h1>
        <p class="page-subtitle">Sua jornada de conhecimento neuro-acessível começa agora. Escolha uma matéria para começar.</p>
        
        <div class="content-grid">
            <div class="glass-card subject-card fisica" data-action="start-default-quiz" data-subject="fisica">
                <div class="icon"><i class="fas fa-atom"></i></div>
                <h2>Física</h2><p>Descubra as leis que movem o universo.</p>
            </div>
            <div class="glass-card subject-card quimica" data-action="start-default-quiz" data-subject="quimica">
                <div class="icon"><i class="fas fa-flask-vial"></i></div>
                <h2>Química</h2><p>Explore a matéria e suas transformações.</p>
            </div>
            <div class="glass-card subject-card biologia" data-action="start-default-quiz" data-subject="biologia">
                <div class="icon"><i class="fas fa-dna"></i></div>
                <h2>Biologia</h2><p>Entenda as maravilhas da vida.</p>
            </div>
            <div class="glass-card subject-card matematica" data-action="start-default-quiz" data-subject="matematica">
                <div class="icon"><i class="fas fa-calculator"></i></div>
                <h2>Matemática</h2><p>Desvende a linguagem dos números.</p>
            </div>
        </div>

        <div class="actions-bar glass-card">
            <button class="btn btn-primary" data-action="show-modal" data-target="joinGameModal"><i class="fas fa-gamepad"></i> Entrar em uma Sala</button>
            <button class="btn btn-secondary" data-action="show-modal" data-target="passwordModal"><i class="fas fa-lock"></i> Modo Professor</button>
            <button class="btn btn-secondary" data-action="navigate" data-target="marketplaceScreen"><i class="fas fa-store"></i> Marketplace de Quizzes</button>
        </div>
    </main>
    
    <section id="quizScreen" class="screen">
        <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="mainMenu"><i class="fas fa-arrow-left"></i> Sair do Quiz</button></div>
        <div class="quiz-content-wrapper" style="width: 100%; max-width: 1200px;">
            <header class="quiz-header glass-card">
                <div class="quiz-stat">Questão: <span id="currentQuestion">1</span>/<span id="totalQuestions">0</span></div>
                <div class="quiz-stat">Pontuação: <span id="score">0</span></div>
            </header>
            <div class="quiz-question-area glass-card">
                 <img id="questionMedia" src="" alt="Mídia da questão" style="display: none;">
                 <h2 id="questionText">Carregando pergunta...</h2>
            </div>
            <div id="optionsContainer" class="options-grid"></div>
        </div>
    </section>

    <section id="professorPanel" class="screen">
        <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="mainMenu"><i class="fas fa-arrow-left"></i> Voltar</button></div>
        <h1 class="page-title" style="text-align: center;">Área do Professor</h1>
        <p class="page-subtitle">Gerencie seus quizzes, crie novas avaliações e acompanhe o desempenho dos alunos.</p>
        <div class="glass-card" style="max-width: 900px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <h3 style="margin: 0;">Meus Quizzes</h3>
                <button class="btn btn-primary" data-action="go-to-editor"><i class="fas fa-plus"></i> Criar Novo Quiz</button>
            </div>
            <div id="customQuizzesList"><p>Carregando seus quizzes...</p></div>
        </div>
    </section>

    <section id="createQuizScreen" class="screen">
        <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="professorPanel"><i class="fas fa-arrow-left"></i> Voltar</button></div>
        <h1 id="createQuizTitle" class="page-title" style="text-align: center;">Criar Quiz</h1>
        <p class="page-subtitle">Preencha os dados abaixo para criar ou editar sua avaliação.</p>
        <div class="glass-card" style="max-width: 900px; text-align: left;">
            <form id="quizEditorForm">
                <input type="hidden" id="editingQuizId">
                <div class="form-group">
                    <label for="quizName">Nome do Quiz</label>
                    <input type="text" id="quizName" class="input-field" placeholder="Ex: Avaliação de Biologia - 1º Trimestre" required>
                </div>
                <div class="form-group">
                    <label for="quizSubject">Matéria</label>
                    <select id="quizSubject" class="select-field" required>
                        <option value="fisica">Física</option><option value="quimica">Química</option>
                        <option value="biologia">Biologia</option><option value="matematica">Matemática</option>
                    </select>
                </div>
                <h3 style="margin: 2rem 0 1rem;">Perguntas</h3>
                <hr style="border-color: var(--cor-borda-vidro); margin-bottom: 2rem;">
                <div id="questionsEditorContainer"></div>
                <button type="button" id="addQuestionBtn" class="btn btn-secondary" style="width: 100%; margin: 1rem 0;"><i class="fas fa-plus"></i> Adicionar Pergunta</button>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.2rem;"><i class="fas fa-save"></i> Salvar Quiz na Nuvem</button>
            </form>
        </div>
    </section>

    <section id="resultsScreen" class="screen">
         <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="professorPanel"><i class="fas fa-arrow-left"></i> Voltar</button></div>
         <h1 id="resultsQuizTitle" class="page-title" style="text-align: center;">Resultados do Quiz</h1>
         <div class="glass-card" style="max-width: 900px; text-align: left;">
            <h3 style="margin-bottom: 1.5rem;">Desempenho dos Alunos</h3>
            <div id="resultsList"><p>Carregando resultados...</p></div>
         </div>
    </section>

    <section id="gameLobbyScreen" class="screen">
        <div class="page-header"><button class="btn btn-danger" id="leaveLobbyBtn"><i class="fas fa-times"></i> Cancelar Sala</button></div>
        <h1 class="page-title" id="lobbyQuizTitle">Aguardando Jogadores</h1>
        <p class="page-subtitle">Peça para os alunos inserirem este código para entrar na sala:</p>
        <div id="lobbyRoomCode" class="lobby-code">------</div>
        <div id="playerList" class="glass-card"></div>
        <button id="startGameBtn" class="btn btn-primary" style="padding: 1rem 3rem; font-size: 1.5rem; margin-top: 2rem;"><i class="fas fa-play"></i> Iniciar Jogo</button>
    </section>

    <section id="marketplaceScreen" class="screen">
        <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="mainMenu"><i class="fas fa-arrow-left"></i> Voltar</button></div>
        <h1 class="page-title" style="text-align: center;">Marketplace de Quizzes</h1>
        <p class="page-subtitle">Explore, descubra e clone quizzes incríveis criados por outros educadores da comunidade.</p>
        <div class="filters">
            <input type="search" id="marketplaceSearch" class="input-field" placeholder="Buscar por título ou matéria..." style="max-width: 400px;">
        </div>
        <div id="marketplace-list">
            <p>Carregando quizzes da comunidade...</p>
        </div>
    </section>

    <div id="passwordModal" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3>Acesso Restrito</h3>
            <div class="form-group"><label for="passwordInput">Senha do Professor</label><input type="password" id="passwordInput" class="input-field" placeholder="A senha é 123456"><p id="passwordError" style="color: var(--cor-errado); display: none; margin-top: 0.5rem;">Senha incorreta.</p></div>
            <div class="modal-buttons"><button data-action="close-modal" class="btn btn-secondary">Cancelar</button><button id="submitPasswordBtn" class="btn btn-primary">Entrar</button></div>
        </div>
    </div>
    <div id="joinGameModal" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3>Entrar em uma Sala de Jogo</h3>
            <div class="form-group"><label for="studentNameInput">Seu Nome</label><input type="text" id="studentNameInput" class="input-field" placeholder="Ex: Ana Silva" required></div>
            <div class="form-group"><label for="roomCodeInput">Código da Sala</label><input type="text" id="roomCodeInput" class="input-field" placeholder="Ex: 123456" required><p id="roomCodeError" style="color: var(--cor-errado); display: none; margin-top: 0.5rem;">Código inválido ou sala não encontrada.</p></div>
            <div class="modal-buttons"><button data-action="close-modal" class="btn btn-secondary">Cancelar</button><button id="submitJoinBtn" class="btn btn-primary">Participar</button></div>
        </div>
    </div>
    <div id="accessibilitySettingsModal" class="modal-overlay">
         <div class="modal-content glass-card" style="max-width: 600px;">
             <h3>Ajustes de Acessibilidade</h3>
             <div id="sensitivity-sliders-container"></div>
             <div class="modal-buttons"><button data-action="close-modal" class="btn btn-primary">Fechar</button></div>
         </div>
    </div>
    <div id="studentResultModal" class="modal-overlay">
        <div class="modal-content glass-card" style="max-width: 800px; text-align: left;">
            <h3 id="studentResultTitle">Detalhes da Resposta</h3>
            <div id="studentResultContent" style="max-height: 60vh; overflow-y: auto; padding-right: 1rem;"></div>
            <div class="modal-buttons" style="margin-top: 2rem;">
                <button data-action="close-modal" class="btn btn-primary">Fechar</button>
            </div>
        </div>
    </div>
    <div id="leaderboardOverlay" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3 id="leaderboardTitle">Placar</h3>
            <div id="leaderboardContent"></div>
            <div class="modal-buttons">
                <button id="nextQuestionBtn" class="btn btn-primary">Próxima Pergunta</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // =======================================================================
        // 1. SETUP INICIAL, ESTADO E VARIÁVEIS GLOBAIS
        // =======================================================================
        let currentScreenId = 'mainMenu';
        let currentSubject = '';
        let score = 0;
        let currentQuestionIndex = 0;
        let currentQuiz = [];
        let questionEditorCounter = 0;
        let activeListeners = {};
        let isDictationModeActive = false;
        let activeDictationInput = null;
        let recognition;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        let gameState = {
            isHost: false,
            roomCode: null,
            playerId: `player_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
            playerName: null,
            currentQuiz: null,
            questionStartTime: 0
        };
        const defaultContent = {
            fisica: { quiz: [{ q: "Qual lei afirma que um corpo em repouso tende a ficar em repouso?", o: ["Inércia", "Ação e Reação", "Dinâmica", "Gravitação"], a: "Inércia" }] },
            quimica: { quiz: [{ q: "Qual partícula tem carga negativa?", o: ["Próton", "Nêutron", "Elétron", "Pósitron"], a: "Elétron" }] },
            biologia: { quiz: [{ q: "Qual organela é a 'central de energia' da célula?", o: ["Núcleo", "Ribossomo", "Mitocôndria", "Lisossomo"], a: "Mitocôndria", mediaUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Mitochondrion_-_TEM.jpg/320px-Mitochondrion_-_TEM.jpg", mediaType: "image" }] },
            matematica: { quiz: [{ q: "Qual o resultado de 9 x 8?", o: ["72", "63", "81", "64"], a: "72" }] }
        };

        // =======================================================================
        // 2. FUNÇÕES DE UI E NAVEGAÇÃO
        // =======================================================================
        const dynamicBackground = document.getElementById('dynamic-background');
        const bgCtx = dynamicBackground.getContext('2d');
        
        function showScreen(screenId) {
            const targetScreen = document.getElementById(screenId);
            if(targetScreen) {
                document.querySelector('.screen.active')?.classList.remove('active');
                targetScreen.classList.add('active');
                currentScreenId = screenId;
                window.scrollTo(0,0);
            }
        }
        function showModal(modalId) { document.getElementById(modalId)?.classList.add('active'); }
        function hideAllModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); }
        
        function setDynamicBackground(subject = 'geral') { /* Implementação omitida por brevidade */ }

        function handleInteraction(e) {
            const el = e.currentTarget;
            const action = el.dataset.action;
            const target = el.dataset.target;

            if (action === 'navigate') showScreen(target);
            else if (action === 'show-modal') showModal(target);
            else if (action === 'close-modal') hideAllModals();
            else if (action === 'start-default-quiz') startDefaultQuiz(el.dataset.subject);
            else if (action === 'go-to-editor') {
                document.getElementById('quizEditorForm').reset();
                document.getElementById('editingQuizId').value = '';
                document.getElementById('createQuizTitle').textContent = 'Criar Novo Quiz';
                document.getElementById('questionsEditorContainer').innerHTML = '';
                questionEditorCounter = 0;
                addQuestionEditor();
                showScreen('createQuizScreen');
            }
        }
        document.querySelectorAll('[data-action]').forEach(el => el.addEventListener('click', handleInteraction));
        document.getElementById('leaveLobbyBtn').addEventListener('click', leaveLobby);
        document.querySelector('[data-target="marketplaceScreen"]').addEventListener('click', renderMarketplace);
        document.getElementById('marketplaceSearch').addEventListener('input', renderMarketplace);
        document.getElementById('submitJoinBtn').addEventListener('click', handleJoinGame);
        document.getElementById('startGameBtn').addEventListener('click', handleStartGame);
        document.getElementById('nextQuestionBtn').addEventListener('click', handleNextQuestion);

        // =======================================================================
        // 3. LÓGICA DO QUIZ PADRÃO (SOLO)
        // =======================================================================
        function startDefaultQuiz(subject) {
            if (!defaultContent[subject]) return;
            currentSubject = subject;
            score = 0;
            currentQuestionIndex = 0;
            currentQuiz = [...defaultContent[subject].quiz].sort(() => Math.random() - 0.5);
            document.getElementById('score').textContent = score;
            document.getElementById('totalQuestions').textContent = currentQuiz.length;
            showScreen('quizScreen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex < currentQuiz.length) {
                const question = currentQuiz[currentQuestionIndex];
                const qMedia = document.getElementById('questionMedia');
                document.getElementById('questionText').textContent = question.q;
                document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
                qMedia.style.display = (question.mediaUrl && question.mediaType === 'image') ? 'block' : 'none';
                qMedia.src = question.mediaUrl || '';
                
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = '';
                const options = [...question.o].sort(() => Math.random() - 0.5);
                const shapes = [{ n: 'triangulo', i: '▲' }, { n: 'losango', i: '♦' }, { n: 'circulo', i: '●' }, { n: 'quadrado', i: '■' }];
                options.forEach((opt, index) => {
                    const btn = document.createElement('button');
                    btn.className = `option-button ${shapes[index].n}`;
                    btn.innerHTML = `<span class="shape">${shapes[index].i}</span> <span class="text">${opt}</span>`;
                    btn.onclick = () => handleAnswer(btn, opt, question.a);
                    optionsContainer.appendChild(btn);
                });
            } else {
                showFinalScore();
            }
        }
        
        function handleAnswer(btn, selected, correct) {
            const allOptions = document.querySelectorAll('.option-button');
            allOptions.forEach(b => b.onclick = null);
            if(selected === correct) {
                score++;
                document.getElementById('score').textContent = score;
                btn.classList.add('correct');
            } else {
                btn.classList.add('wrong');
                allOptions.forEach(optBtn => { if(optBtn.querySelector('.text').textContent === correct) optBtn.classList.add('reveal-correct'); });
            }
            setTimeout(() => { currentQuestionIndex++; loadQuestion(); }, 2000);
        }

        function showFinalScore() {
            document.getElementById('questionText').innerHTML = `Quiz Concluído!`;
            document.getElementById('optionsContainer').innerHTML = `
                <div class="glass-card" style="grid-column: 1 / -1; text-align: center;">
                    <p style="font-size: 1.5rem;">Sua pontuação final foi:</p>
                    <p style="font-size: 4rem; font-weight: bold; color: var(--cor-${currentSubject});">${score} de ${currentQuiz.length}</p>
                    <button class="btn btn-primary" data-action="navigate" data-target="mainMenu" style="margin-top: 2rem;">Voltar ao Menu</button>
                </div>`;
            document.querySelector('#optionsContainer button').addEventListener('click', handleInteraction);
        }

        // =======================================================================
        // 4. MODO PROFESSOR: CRUD DE QUIZZES, RESULTADOS E PUBLICAÇÃO
        // =======================================================================
        document.getElementById('submitPasswordBtn').addEventListener('click', () => {
            if(document.getElementById('passwordInput').value === '123456'){
                hideAllModals();
                showScreen('professorPanel');
                renderCustomQuizzes();
            } else {
                document.getElementById('passwordError').style.display = 'block';
            }
        });
        
        window.renderCustomQuizzes = function() {
            const listContainer = document.getElementById('customQuizzesList');
            listContainer.innerHTML = '<p>Buscando seus quizzes na nuvem...</p>';
            database.ref('quizzes').once('value', snapshot => {
                listContainer.innerHTML = '';
                const quizzes = snapshot.val();
                if (!quizzes) {
                    listContainer.innerHTML = '<p>Você ainda não criou nenhum quiz. Clique em "Criar Novo Quiz" para começar!</p>';
                    return;
                }
                Object.values(quizzes).forEach(quiz => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div>
                            <div class="list-item-title">${quiz.name}</div>
                            <small style="color:var(--cor-texto-secundario); text-transform: capitalize;">
                                ${quiz.subject} - ${quiz.questions.length} Questões - Cód: ${quiz.id}
                            </small>
                        </div>
                        <div class="list-item-actions">
                            <button title="Criar Sala de Jogo" class="btn btn-primary btn-sm" onclick="window.createGameRoom('${quiz.id}')"><i class="fas fa-play"></i> Iniciar</button>
                            <button title="Publicar no Marketplace" class="btn btn-success btn-sm" onclick="window.publishQuiz('${quiz.id}')"><i class="fas fa-store"></i></button>
                            <button title="Resultados" onclick="window.viewResults('${quiz.id}', '${quiz.name}')"><i class="fas fa-chart-bar"></i></button>
                            <button title="Editar Quiz" onclick="window.editQuiz('${quiz.id}')"><i class="fas fa-edit"></i></button>
                            <button title="Excluir Quiz" onclick="window.deleteQuiz('${quiz.id}')" class="btn-danger"><i class="fas fa-trash"></i></button>
                        </div>`;
                    listContainer.appendChild(item);
                });
            });
        }

        document.getElementById('addQuestionBtn').addEventListener('click', () => addQuestionEditor());
        
        function addQuestionEditor(questionData = null) {
            questionEditorCounter++;
            const container = document.getElementById('questionsEditorContainer');
            const editorDiv = document.createElement('div');
            editorDiv.className = 'question-editor';
            editorDiv.id = `q-editor-${questionEditorCounter}`;

            const qText = questionData ? questionData.q : '';
            const mediaUrl = questionData ? questionData.mediaUrl : '';
            const options = questionData ? questionData.o : ['', '', '', ''];
            const correctAnswer = questionData ? questionData.a : '';

            editorDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                    <h4 style="margin:0;">Pergunta ${questionEditorCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-trash"></i></button>
                </div>
                <div class="form-group">
                    <input type="text" class="input-field question-title" placeholder="Enunciado da pergunta" value="${qText}" required>
                </div>
                <div class="form-group">
                    <input type="url" class="input-field media-url" placeholder="URL da Imagem (Opcional)" value="${mediaUrl}">
                </div>
                <div class="form-group">
                    <label>Opções (Marque a correta)</label>
                    ${[0,1,2,3].map(i => `
                        <div class="option-editor">
                            <input type="radio" name="correct-opt-${questionEditorCounter}" value="${i}" ${options[i] === correctAnswer ? 'checked' : ''} required>
                            <input type="text" class="input-field option-text" placeholder="Opção ${i + 1}" value="${options[i] || ''}" required>
                        </div>`).join('')
                    }
                </div>`;
            container.appendChild(editorDiv);
        }

        document.getElementById('quizEditorForm').addEventListener('submit', e => {
            e.preventDefault();
            const quizId = document.getElementById('editingQuizId').value || `QUIZ${Date.now()}`;
            const quizData = {
                id: quizId,
                name: document.getElementById('quizName').value,
                subject: document.getElementById('quizSubject').value,
                questions: []
            };

            document.querySelectorAll('.question-editor').forEach(editor => {
                const questionText = editor.querySelector('.question-title').value;
                const mediaUrl = editor.querySelector('.media-url').value;
                const options = Array.from(editor.querySelectorAll('.option-text')).map(input => input.value);
                const correctRadio = editor.querySelector('input[type="radio"]:checked');
                if (!correctRadio) {
                    alert("Por favor, marque uma resposta correta para cada pergunta.");
                    throw new Error("Resposta correta não selecionada.");
                }
                const correctAnswer = options[parseInt(correctRadio.value)];
                
                quizData.questions.push({
                    q: questionText,
                    o: options,
                    a: correctAnswer,
                    mediaUrl: mediaUrl || null,
                    mediaType: mediaUrl ? 'image' : null
                });
            });

            database.ref('quizzes/' + quizId).set(quizData)
                .then(() => {
                    alert('Quiz salvo com sucesso na nuvem! Código: ' + quizId);
                    showScreen('professorPanel');
                    renderCustomQuizzes();
                })
                .catch(error => alert('Ocorreu um erro ao salvar o quiz: ' + error.message));
        });
        
        window.editQuiz = (quizId) => {
            database.ref('quizzes/' + quizId).once('value', snapshot => {
                const quiz = snapshot.val();
                if (!quiz) { alert("Quiz não encontrado!"); return; }
                showScreen('createQuizScreen');
                document.getElementById('createQuizTitle').textContent = 'Editar Quiz';
                document.getElementById('editingQuizId').value = quiz.id;
                document.getElementById('quizName').value = quiz.name;
                document.getElementById('quizSubject').value = quiz.subject;

                const questionsContainer = document.getElementById('questionsEditorContainer');
                questionsContainer.innerHTML = '';
                questionEditorCounter = 0;
                quiz.questions.forEach(questionData => addQuestionEditor(questionData));
            });
        };

        window.deleteQuiz = (quizId) => {
            if (confirm(`Tem certeza que deseja excluir o quiz ${quizId}? Esta ação não pode ser desfeita.`)) {
                database.ref('quizzes/' + quizId).remove()
                    .then(() => {
                        database.ref('results/' + quizId).remove(); // Apaga resultados associados
                        alert('Quiz excluído com sucesso.');
                        renderCustomQuizzes();
                    })
                    .catch(error => alert('Erro ao excluir o quiz: ' + error.message));
            }
        };

        window.viewResults = (quizId, quizName) => {
            showScreen('resultsScreen');
            document.getElementById('resultsQuizTitle').textContent = `Resultados: ${quizName}`;
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '<p>Buscando resultados...</p>';

            database.ref('results/' + quizId).orderByChild('date').once('value', snapshot => {
                const results = snapshot.val();
                if (!results) {
                    resultsList.innerHTML = '<p>Nenhum aluno respondeu a este quiz ainda.</p>';
                    return;
                }
                resultsList.innerHTML = '';
                Object.values(results).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div>
                            <div class="list-item-title">${result.studentName}</div>
                            <small>Pontuação: ${result.score}/${result.totalQuestions} - Em: ${new Date(result.date).toLocaleString('pt-BR')}</small>
                        </div>
                        <div class="list-item-actions">
                            <button title="Ver Detalhes" onclick="window.showStudentResultDetail('${result.key}')"><i class="fas fa-eye"></i></button>
                        </div>`;
                    resultsList.appendChild(item);
                });
            });
        };

        window.showStudentResultDetail = (resultKey) => {
            // Lógica para buscar e mostrar detalhes de um resultado específico (se necessário)
            alert('Funcionalidade de detalhe de resultado a ser implementada.');
        };
        
        // =======================================================================
        // 5. MARKETPLACE: NAVEGAÇÃO, PUBLICAÇÃO E CLONAGEM
        // =======================================================================
        function renderMarketplace() {
            const listContainer = document.getElementById('marketplace-list');
            listContainer.innerHTML = '<p>Buscando quizzes da comunidade...</p>';
            const searchTerm = document.getElementById('marketplaceSearch').value.toLowerCase();

            database.ref('marketplace').once('value', snapshot => {
                listContainer.innerHTML = '';
                const marketplaceQuizzes = snapshot.val();
                if (!marketplaceQuizzes) {
                    listContainer.innerHTML = '<p>Nenhum quiz na comunidade ainda. Seja o primeiro a publicar!</p>';
                    return;
                }
                
                const filteredQuizzes = Object.values(marketplaceQuizzes).filter(q => 
                    q.title.toLowerCase().includes(searchTerm) || q.subject.toLowerCase().includes(searchTerm)
                );

                if (filteredQuizzes.length === 0) {
                    listContainer.innerHTML = '<p>Nenhum quiz encontrado com seu termo de busca.</p>';
                    return;
                }

                filteredQuizzes.forEach(quiz => {
                    const card = document.createElement('div');
                    card.className = 'glass-card marketplace-card';
                    card.style.borderColor = `var(--cor-${quiz.subject})`;
                    card.innerHTML = `
                        <h3>${quiz.title}</h3>
                        <p>Criado por <span class="author">${quiz.authorName || 'Anônimo'}</span></p>
                        <div class="stats">
                            <span><i class="fas fa-book"></i> ${quiz.subject.charAt(0).toUpperCase() + quiz.subject.slice(1)}</span>
                            <span><i class="fas fa-question-circle"></i> ${quiz.questionCount} Questões</span>
                            <span><i class="fas fa-clone"></i> Clonado ${quiz.clonedCount || 0} vezes</span>
                        </div>
                        <div style="text-align: right; margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="window.cloneQuiz('${quiz.originalQuizId}')"><i class="fas fa-clone"></i> Clonar para Minha Conta</button>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            });
        }

        window.publishQuiz = async (quizId) => {
            const marketplaceRef = database.ref('marketplace/' + quizId);
            const marketplaceSnapshot = await marketplaceRef.once('value');
            if (marketplaceSnapshot.exists()) {
                alert("Este quiz já foi publicado no Marketplace.");
                return;
            }

            const quizSnapshot = await database.ref('quizzes/' + quizId).once('value');
            const quiz = quizSnapshot.val();
            if (!quiz) {
                alert("Erro: não foi possível encontrar os dados do quiz.");
                return;
            }

            const marketplaceEntry = {
                originalQuizId: quiz.id,
                title: quiz.name,
                subject: quiz.subject,
                questionCount: quiz.questions.length,
                authorName: "Professor Anônimo", // Em um sistema real, viria do perfil do usuário
                publishedAt: new Date().toISOString(),
                clonedCount: 0
            };

            await marketplaceRef.set(marketplaceEntry);
            alert("Quiz publicado no Marketplace com sucesso!");
        };

        window.cloneQuiz = async (originalQuizId) => {
            if (!confirm("Tem certeza de que deseja clonar este quiz para a sua conta?")) return;

            const quizSnapshot = await database.ref('quizzes/' + originalQuizId).once('value');
            const originalQuiz = quizSnapshot.val();
            if (!originalQuiz) {
                alert("Erro: O quiz original não foi encontrado e pode ter sido excluído.");
                return;
            }

            const newQuizId = `QUIZ${Date.now()}`;
            const clonedQuiz = { ...originalQuiz };
            clonedQuiz.id = newQuizId;
            clonedQuiz.name = `(Cópia) ${originalQuiz.name}`;
            
            await database.ref('quizzes/' + newQuizId).set(clonedQuiz);
            
            const cloneCountRef = database.ref(`marketplace/${originalQuizId}/clonedCount`);
            await cloneCountRef.transaction(currentCount => (currentCount || 0) + 1);

            alert(`Quiz "${originalQuiz.name}" clonado com sucesso para sua conta!`);
            renderMarketplace(); // Atualiza a contagem na UI
        };

        // =======================================================================
        // 6. SALA DE AULA EM TEMPO REAL: LOBBY, JOGO E PLACAR
        // =======================================================================
        window.createGameRoom = async (quizId) => {
            const roomCode = Math.floor(100000 + Math.random() * 900000).toString();
            const quizSnapshot = await database.ref('quizzes/' + quizId).once('value');
            const quizData = quizSnapshot.val();
            if (!quizData) { alert("Erro: Quiz não encontrado!"); return; }

            const roomData = {
                quizId: quizId, quizTitle: quizData.name, quizSubject: quizData.subject,
                hostId: gameState.playerId, status: 'lobby', currentQuestionIndex: -1,
                players: {}, answers: {}
            };
            await database.ref('gameRooms/' + roomCode).set(roomData);
            gameState.isHost = true;
            await joinLobby(roomCode, "Professor");
        };

        async function handleJoinGame() {
            const playerName = document.getElementById('studentNameInput').value;
            const roomCode = document.getElementById('roomCodeInput').value;
            if (!playerName || !roomCode) { alert("Preencha seu nome e o código da sala."); return; }
            
            const roomRef = database.ref('gameRooms/' + roomCode);
            const snapshot = await roomRef.once('value');
            if (snapshot.exists() && snapshot.val().status === 'lobby') {
                gameState.isHost = false;
                await joinLobby(roomCode, playerName);
            } else {
                document.getElementById('roomCodeError').style.display = 'block';
            }
        }

        async function joinLobby(roomCode, playerName) {
            gameState.roomCode = roomCode;
            gameState.playerName = playerName;
            
            const playerRef = database.ref(`gameRooms/${roomCode}/players/${gameState.playerId}`);
            await playerRef.set({ name: playerName, score: 0 });
            await playerRef.onDisconnect().remove();

            hideAllModals();
            showScreen('gameLobbyScreen');
            listenToRoomChanges(roomCode);
        }

        function listenToRoomChanges(roomCode) {
            const roomRef = database.ref('gameRooms/' + roomCode);
            if (activeListeners.room) activeListeners.room.off();
            activeListeners.room = roomRef;

            roomRef.on('value', async snapshot => {
                const roomData = snapshot.val();
                if (!roomData) {
                    alert("A sala de jogo foi fechada.");
                    leaveLobby();
                    return;
                }

                document.getElementById('lobbyQuizTitle').textContent = roomData.quizTitle;
                document.getElementById('lobbyRoomCode').textContent = roomCode;
                const playerList = document.getElementById('playerList');
                playerList.innerHTML = '';
                if (roomData.players) {
                    Object.values(roomData.players).forEach(player => {
                        const chip = document.createElement('div');
                        chip.className = 'player-chip';
                        chip.textContent = player.name;
                        playerList.appendChild(chip);
                    });
                }
                
                document.getElementById('startGameBtn').style.display = gameState.isHost ? 'inline-flex' : 'none';

                if (!gameState.currentQuiz && roomData.quizId) {
                     const quizSnapshot = await database.ref(`quizzes/${roomData.quizId}`).once('value');
                     gameState.currentQuiz = quizSnapshot.val();
                }

                switch(roomData.status) {
                    case 'in_progress':
                        hideAllModals();
                        showScreen('quizScreen');
                        loadRealtimeQuestion(roomData.currentQuestionIndex);
                        break;
                    case 'leaderboard':
                        showLeaderboard(roomData);
                        break;
                    case 'finished':
                        showFinalLeaderboard(roomData);
                        break;
                }
            });
        }
        
        function handleStartGame() {
            if (gameState.isHost && gameState.roomCode) {
                database.ref(`gameRooms/${gameState.roomCode}`).update({
                    status: 'in_progress',
                    currentQuestionIndex: 0
                });
            }
        }

        function loadRealtimeQuestion(qIndex) {
            if (!gameState.currentQuiz) return;
            const question = gameState.currentQuiz.questions[qIndex];
            document.getElementById('questionText').textContent = question.q;
            document.getElementById('currentQuestion').textContent = qIndex + 1;
            document.getElementById('totalQuestions').textContent = gameState.currentQuiz.questions.length;
            
            const qMedia = document.getElementById('questionMedia');
            qMedia.style.display = (question.mediaUrl && question.mediaType === 'image') ? 'block' : 'none';
            qMedia.src = question.mediaUrl || '';
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            const shapes = [{ n: 'triangulo', i: '▲' }, { n: 'losango', i: '♦' }, { n: 'circulo', i: '●' }, { n: 'quadrado', i: '■' }];
            question.o.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = `option-button ${shapes[index].n}`;
                btn.innerHTML = `<span class="shape">${shapes[index].i}</span> <span class="text">${opt}</span>`;
                btn.onclick = () => submitAnswer(opt);
                optionsContainer.appendChild(btn);
            });

            gameState.questionStartTime = Date.now();

            if (gameState.isHost) {
                setTimeout(() => {
                    database.ref(`gameRooms/${gameState.roomCode}`).update({ status: 'leaderboard' });
                }, 20000); // 20 segundos
            }
        }
        
        function submitAnswer(selectedAnswer) {
            document.querySelectorAll('.option-button').forEach(b => b.disabled = true);
            const timeTaken = (Date.now() - gameState.questionStartTime) / 1000;
            
            database.ref(`gameRooms/${gameState.roomCode}/answers/${gameState.currentQuiz.questions.length > currentQuestionIndex ? currentQuestionIndex : -1}/${gameState.playerId}`).set({
                answer: selectedAnswer,
                time: timeTaken
            });
        }

        async function showLeaderboard(roomData) {
            const qIndex = roomData.currentQuestionIndex;
            const question = gameState.currentQuiz.questions[qIndex];
            const correctAnswer = question.a;
            const answers = roomData.answers ? (roomData.answers[qIndex] || {}) : {};

            if (gameState.isHost) {
                const updates = {};
                for (const playerId in roomData.players) {
                    if (answers[playerId] && answers[playerId].answer === correctAnswer) {
                        const timeScore = Math.max(0, 1000 - (answers[playerId].time * 50));
                        updates[`/players/${playerId}/score`] = roomData.players[playerId].score + 1000 + Math.floor(timeScore);
                    }
                }
                await database.ref(`gameRooms/${gameState.roomCode}`).update(updates);
            }
            
            const leaderboardSnapshot = await database.ref(`gameRooms/${gameState.roomCode}/players`).orderByChild('score').once('value');
            const players = [];
            leaderboardSnapshot.forEach(snap => { players.push(snap.val()); });
            players.reverse(); // Ordem decrescente
            
            const leaderboardContent = document.getElementById('leaderboardContent');
            leaderboardContent.innerHTML = '';
            players.slice(0, 5).forEach((player, index) => {
                leaderboardContent.innerHTML += `
                    <div class="leaderboard-item">
                        <span class="rank">#${index + 1}</span>
                        <span class="name">${player.name}</span>
                        <span class="score">${player.score}</span>
                    </div>`;
            });

            document.getElementById('nextQuestionBtn').style.display = gameState.isHost ? 'inline-flex' : 'none';
            document.getElementById('leaderboardTitle').textContent = "Placar Parcial";
            showModal('leaderboardOverlay');
        }
        
        async function handleNextQuestion() {
            const roomSnapshot = await database.ref(`gameRooms/${gameState.roomCode}`).once('value');
            const roomData = roomSnapshot.val();
            const newIndex = roomData.currentQuestionIndex + 1;
            
            if (newIndex < gameState.currentQuiz.questions.length) {
                database.ref(`gameRooms/${gameState.roomCode}`).update({
                    status: 'in_progress',
                    currentQuestionIndex: newIndex
                });
            } else {
                database.ref(`gameRooms/${gameState.roomCode}`).update({ status: 'finished' });
            }
        }
        
        function showFinalLeaderboard(roomData) {
            showLeaderboard(roomData); // Mostra o placar final
            document.getElementById('leaderboardTitle').textContent = "Placar Final!";
            document.getElementById('nextQuestionBtn').textContent = "Fechar Sala";
            document.getElementById('nextQuestionBtn').onclick = leaveLobby;
        }

        function leaveLobby() {
            if (activeListeners.room) activeListeners.room.off();
            if (gameState.isHost && gameState.roomCode) {
                database.ref('gameRooms/' + gameState.roomCode).remove();
            }
            // Resetar estado do jogo
            gameState = { ...gameState, isHost: false, roomCode: null, playerName: null, currentQuiz: null };
            hideAllModals();
            showScreen('mainMenu');
        }

        // =======================================================================
        // 7. ACESSIBILIDADE NÍVEL 2: CONTROLE POR VOZ (COM DITADO) E CÂMERA
        // =======================================================================
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.interimResults = false;

            recognition.onstart = () => document.getElementById('access-mic-btn').classList.add('active');
            recognition.onend = () => document.getElementById('access-mic-btn').classList.remove('active');
            recognition.onerror = e => console.error("Erro de voz:", e.error);
            recognition.onresult = (event) => {
                const command = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
                console.log("Comando de voz:", command);
                handleVoiceCommand(command);
            };
            document.getElementById('access-mic-btn').addEventListener('click', () => {
                if (isDictationModeActive) return;
                try { recognition.continuous = false; recognition.start(); } catch(e) { console.error("Não foi possível iniciar o microfone", e); }
            });
        } else {
            document.getElementById('access-mic-btn').style.display = 'none';
        }

        function handleVoiceCommand(command) {
            if (command.includes('iniciar ditado') && activeDictationInput) {
                isDictationModeActive = true;
                if(recognition) { recognition.continuous = true; recognition.start(); }
                alert("Modo ditado ativado. Fale o conteúdo. Diga 'parar ditado' para finalizar.");
                return;
            }
            if (command.includes('parar ditado')) {
                isDictationModeActive = false;
                if(recognition) { recognition.continuous = false; recognition.stop(); }
                alert("Modo ditado desativado.");
                return;
            }

            if (isDictationModeActive && activeDictationInput) {
                activeDictationInput.value += command + " ";
                return;
            }
            
            if (command.includes('voltar') || command.includes('sair') || command.includes('fechar')) {
                const backBtn = document.querySelector('.screen.active .page-header button, .modal-overlay.active [data-action=close-modal]');
                if(backBtn) backBtn.click();
                return;
            }

            if (currentScreenId === 'mainMenu') {
                if (command.includes('física')) document.querySelector('[data-subject="fisica"]').click();
                else if (command.includes('química')) document.querySelector('[data-subject="quimica"]').click();
                else if (command.includes('biologia')) document.querySelector('[data-subject="biologia"]').click();
                else if (command.includes('matemática')) document.querySelector('[data-subject="matematica"]').click();
                else if (command.includes('modo professor')) document.querySelector('[data-target="passwordModal"]').click();
            } else if (currentScreenId === 'quizScreen') {
                const commandMap = { 'triângulo': 0, 'vermelho': 0, 'losango': 1, 'azul': 1, 'círculo': 2, 'amarelo': 2, 'quadrado': 3, 'verde': 3 };
                for (const key in commandMap) {
                    if (command.includes(key)) { document.querySelectorAll('.option-button')[commandMap[key]]?.click(); return; }
                }
            }
        }
        
        document.getElementById('createQuizScreen').addEventListener('focusin', (e) => {
            if (e.target.matches('.input-field.question-title, .input-field.option-text')) {
                activeDictationInput = e.target;
            }
        });
        document.getElementById('createQuizScreen').addEventListener('focusout', (e) => {
            if (e.target === activeDictationInput) {
                activeDictationInput = null;
                if (isDictationModeActive) {
                    isDictationModeActive = false;
                    if(recognition) { recognition.continuous = false; recognition.stop(); }
                }
            }
        });
        
        console.log("Ciência Interativa Neuro-Acessível: PROJETO COMPLETO INICIALIZADO.");
    });
    </script>

    <script type="module">
        // MÓDULO DE ACESSIBILIDADE (NEURO CONTROL) - NÍVEL 2
        const video = document.getElementById('video-preview');
        const camBtn = document.getElementById('access-cam-btn');
        const eyeCursor = document.getElementById('eye-cursor');
        const settingsBtn = document.getElementById('access-settings-btn');
        const settingsModal = document.getElementById('accessibilitySettingsModal');
        
        let faceMesh, isCameraActive = false, cameraStream;
        let SENSITIVITIES = { blink: 0.25, mouthOpen: 0.08, smile: 4.0 };
        const DEBOUNCE_TIME = { blink: 300, mouthOpen: 600, smile: 400 };
        let state = { 
            isBlinking: false, blinkTimeout: null, 
            isMouthOpen: false, mouthOpenTimeout: null,
            isSmiling: false, wasSmiling: false, smileTimeout: null,
            isDragging: false, draggedElement: null 
        };

        function getDistance(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }
        
        function onResults(results) {
            if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;
            const landmarks = results.multiFaceLandmarks[0];

            // 1. Movimento do Cursor com base no olho direito
            const p_r_eye = landmarks[468]; 
            if(p_r_eye) {
                const x = (1 - p_r_eye.x) * window.innerWidth;
                const y = p_r_eye.y * window.innerHeight;
                eyeCursor.style.transform = `translate3d(${x}px, ${y}px, 0)`;
                const el = document.elementFromPoint(x, y);
                document.querySelectorAll('.focused').forEach(e => e.classList.remove('focused'));
                if (el && (el.matches('[data-action], .option-button') || el.closest('.question-editor'))) {
                   el.closest('[data-action], .option-button, .question-editor').classList.add('focused');
                }
            }

            // 2. Piscada (Clique)
            const p_l_top = landmarks[159], p_l_bottom = landmarks[145], p_l_left = landmarks[33], p_l_right = landmarks[133];
            const ear = getDistance(p_l_top, p_l_bottom) / getDistance(p_l_left, p_l_right);
            if (ear < SENSITIVITIES.blink && !state.isBlinking) {
                state.isBlinking = true;
                eyeCursor.classList.add('blinking');
                state.blinkTimeout = setTimeout(() => {
                    const el = document.querySelector('.focused');
                    if(el) el.click();
                    state.isBlinking = false;
                }, DEBOUNCE_TIME.blink);
            } else if (ear >= SENSITIVITIES.blink && state.isBlinking) {
                eyeCursor.classList.remove('blinking');
                clearTimeout(state.blinkTimeout);
                state.isBlinking = false;
            }
            
            // 3. Boca Aberta (Voltar)
            const p_m_top = landmarks[13], p_m_bottom = landmarks[14], p_m_left = landmarks[61], p_m_right = landmarks[291];
            const mar = getDistance(p_m_top, p_m_bottom) / getDistance(p_m_left, p_m_right);
            if (mar > SENSITIVITIES.mouthOpen && !state.isMouthOpen) {
                state.isMouthOpen = true;
                state.mouthOpenTimeout = setTimeout(() => {
                    const backBtn = document.querySelector('.screen.active .page-header button, .modal-overlay.active [data-action=close-modal]');
                    if (backBtn) backBtn.click();
                    state.isMouthOpen = false;
                }, DEBOUNCE_TIME.mouthOpen);
            } else if (mar <= SENSITIVITIES.mouthOpen && state.isMouthOpen) {
                clearTimeout(state.mouthOpenTimeout);
                state.isMouthOpen = false;
            }

            // 4. Sorriso (Arrastar e Soltar)
            const smileRatio = getDistance(landmarks[61], landmarks[291]) / getDistance(landmarks[0], landmarks[17]);
            state.isSmiling = smileRatio > SENSITIVITIES.smile;

            if (state.isSmiling && !state.wasSmiling) { // Sorriso começou
                state.wasSmiling = true;
                const focusedElement = document.querySelector('.question-editor.focused');
                if (focusedElement) {
                    state.isDragging = true;
                    state.draggedElement = focusedElement;
                    state.draggedElement.classList.add('is-dragging');
                    eyeCursor.classList.add('dragging');
                }
            } else if (!state.isSmiling && state.wasSmiling) { // Sorriso terminou
                state.wasSmiling = false;
                if (state.isDragging && state.draggedElement) {
                    state.draggedElement.classList.remove('is-dragging');
                    eyeCursor.classList.remove('dragging');
                    const dropTarget = document.querySelector('.question-editor.focused');
                    if (dropTarget && dropTarget !== state.draggedElement) {
                        dropTarget.parentElement.insertBefore(state.draggedElement, dropTarget);
                    }
                }
                state.isDragging = false;
                state.draggedElement = null;
            }
        }

        async function startFaceTracking() {
            faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
            faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            faceMesh.onResults(onResults);
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = cameraStream;
                video.style.display = 'block';
                await video.play();
                isCameraActive = true;
                eyeCursor.style.display = 'block';
                camBtn.classList.add('active');
                frameLoop();
            } catch (err) { alert("Erro ao acessar a câmera: " + err); }
        }
        function stopFaceTracking() {
            isCameraActive = false;
            cameraStream?.getTracks().forEach(track => track.stop());
            video.style.display = 'none';
            eyeCursor.style.display = 'none';
            camBtn.classList.remove('active');
            if (faceMesh) { faceMesh.close(); faceMesh = null; }
        }
        async function frameLoop() { 
            if (isCameraActive && faceMesh && video.readyState >= 3) { 
                await faceMesh.send({ image: video }); 
            }
            if(isCameraActive) requestAnimationFrame(frameLoop); 
        }
        
        camBtn.addEventListener('click', () => { if (isCameraActive) stopFaceTracking(); else startFaceTracking(); });
        settingsBtn.addEventListener('click', () => { 
            document.getElementById('accessibilitySettingsModal').classList.add('active'); 
            renderSettings(); 
        });

        function renderSettings() {
            const container = document.getElementById('sensitivity-sliders-container');
            container.innerHTML = `<div class="form-group"><label>Sensibilidade do PISCAR (Clique)</label><input type="range" class="input-field" min="0.15" max="0.4" step="0.01" value="${SENSITIVITIES.blink}" oninput="window.updateSensitivity('blink', this.value)"></div><div class="form-group"><label>Sensibilidade de ABRIR A BOCA (Voltar)</label><input type="range" class="input-field" min="0.05" max="0.2" step="0.01" value="${SENSITIVITIES.mouthOpen}" oninput="window.updateSensitivity('mouthOpen', this.value)"></div><div class="form-group"><label>Sensibilidade do SORRISO (Arrastar)</label><input type="range" class="input-field" min="3.0" max="5.0" step="0.1" value="${SENSITIVITIES.smile}" oninput="window.updateSensitivity('smile', this.value)"></div>`;
        }
        window.updateSensitivity = (key, value) => { SENSITIVITIES[key] = parseFloat(value); };
    </script>
</body>
</html>
